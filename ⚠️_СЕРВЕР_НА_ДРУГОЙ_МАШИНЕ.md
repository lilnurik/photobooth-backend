# ‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ù–û: –°–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω –ù–ï –∏–∑ –ª–æ–∫–∞–ª—å–Ω–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏!

## –ü—Ä–æ–±–ª–µ–º–∞

–¢—ã —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ—à—å —Ñ–∞–π–ª:
```
D:\fotobox+react\photobooth-magic-main\backend\app.py
```

–ù–æ —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω –∏–∑:
```
/var/www/photobooth-backend/app.py  (–Ω–∞ –º–∞—à–∏–Ω–µ 10.10.0.172)
```

**–ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ –ª–æ–∫–∞–ª—å–Ω–æ–º —Ñ–∞–π–ª–µ –ù–ï –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ!**

---

## üö® –†–µ—à–µ–Ω–∏–µ: –æ–±–Ω–æ–≤–∏—Ç—å —Ñ–∞–π–ª –Ω–∞ –°–ï–†–í–ï–†–ï

### –í–∞—Ä–∏–∞–Ω—Ç 1: –ï—Å–ª–∏ —ç—Ç–æ —Ç–æ—Ç –∂–µ –∫–æ–º–ø—å—é—Ç–µ—Ä (WSL/VM)

–ï—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω –≤ WSL –∏–ª–∏ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–π –º–∞—à–∏–Ω–µ –Ω–∞ —ç—Ç–æ–º –∂–µ –∫–æ–º–ø—å—é—Ç–µ—Ä–µ:

```bash
# 1. –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–µ—Ä–≤–µ—Ä (–Ω–∞–π–¥–∏ –æ–∫–Ω–æ –≥–¥–µ –∑–∞–ø—É—â–µ–Ω python app.py –∏ –Ω–∞–∂–º–∏ Ctrl+C)

# 2. –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π —Ñ–∞–π–ª
copy D:\fotobox+react\photobooth-magic-main\backend\app.py \\wsl$\Ubuntu\var\www\photobooth-backend\app.py

# 3. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ä–≤–µ—Ä –≤ WSL
wsl
cd /var/www/photobooth-backend
python app.py
```

### –í–∞—Ä–∏–∞–Ω—Ç 2: –ï—Å–ª–∏ —ç—Ç–æ —É–¥–∞–ª—ë–Ω–Ω—ã–π —Å–µ—Ä–≤–µ—Ä (10.10.0.172)

```bash
# 1. –ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É –ø–æ SSH
ssh user@10.10.0.172

# 2. –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–µ—Ä–≤–µ—Ä
# (–Ω–∞–π–¥–∏ –ø—Ä–æ—Ü–µ—Å—Å: ps aux | grep app.py)
# (—É–±–µ–π: kill <PID> –∏–ª–∏ sudo systemctl stop photobooth)

# 3. –û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ñ–∞–π–ª –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
nano /var/www/photobooth-backend/app.py

# 4. –ù–∞–π—Ç–∏ —Å—Ç—Ä–æ–∫—É: elif method == 'CreateTransaction':
# 5. –ó–∞–º–µ–Ω–∏—Ç—å –≤–µ—Å—å –±–ª–æ–∫ –∫–æ–¥–æ–º –∏–∑ app_fixed_createtransaction.py

# 6. –°–æ—Ö—Ä–∞–Ω–∏—Ç—å (Ctrl+O, Enter, Ctrl+X)

# 7. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ä–≤–µ—Ä
cd /var/www/photobooth-backend
python app.py
```

### –í–∞—Ä–∏–∞–Ω—Ç 3: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å SCP –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è

```bash
# –° Windows –Ω–∞ Linux —Å–µ—Ä–≤–µ—Ä
scp D:\fotobox+react\photobooth-magic-main\backend\app.py user@10.10.0.172:/var/www/photobooth-backend/app.py

# –ü–æ—Ç–æ–º –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
ssh user@10.10.0.172 "cd /var/www/photobooth-backend && python app.py"
```

---

## üìù –ß—Ç–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ –Ω—É–∂–Ω–æ –∏—Å–ø—Ä–∞–≤–∏—Ç—å –≤ app.py

–ù–∞–π–¥–∏ –≤ —Ñ–∞–π–ª–µ `/var/www/photobooth-backend/app.py` —ç—Ç–æ—Ç –±–ª–æ–∫:

```python
elif method == 'CreateTransaction':
    transaction_id = params.get('id')
    amount = params.get('amount')
    account = params.get('account', {})
    order_id = account.get('order_id')
    
    print(f"DEBUG: CreateTransaction order_id={order_id}, transaction_id={transaction_id}", flush=True)
    
    # ‚ùå –°–¢–ê–†–´–ô –ö–û–î (–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π):
    payment = Payment.query.filter_by(transaction_id=transaction_id).first()
    
    if not payment:
        # –°–æ–∑–¥–∞—ë–º –Ω–æ–≤—ã–π –ø–ª–∞—Ç—ë–∂  ‚Üê –ü–†–û–ë–õ–ï–ú–ê –ó–î–ï–°–¨!
        payment = Payment(
            order_id=order_id,  # ‚Üê –¥—É–±–ª—å order_id ‚Üí UNIQUE constraint failed
            transaction_id=transaction_id,
            amount=amount // 100,
            payment_type='payme',
            status='pending',
            state=1,
            create_time=datetime.utcnow()
        )
        db.session.add(payment)  # ‚Üê –ü–æ–ø—ã—Ç–∫–∞ INSERT ‚Üí –æ—à–∏–±–∫–∞
        db.session.commit()
```

**–ó–∞–º–µ–Ω–∏—Ç—å –Ω–∞:**

```python
elif method == 'CreateTransaction':
    transaction_id = params.get('id')
    amount = params.get('amount')
    account = params.get('account', {})
    order_id = account.get('order_id')
    
    print(f"DEBUG: CreateTransaction order_id={order_id}, transaction_id={transaction_id}", flush=True)
    
    # ‚úÖ –ù–û–í–´–ô –ö–û–î (–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π):
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –ø–æ transaction_id
    existing = Payment.query.filter_by(transaction_id=transaction_id).first()
    if existing:
        # –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è —É–∂–µ –±—ã–ª–∞ —Å–æ–∑–¥–∞–Ω–∞
        return jsonify({
            "id": id,
            "result": {
                "create_time": int(existing.create_time.timestamp() * 1000),
                "transaction": str(existing.id),
                "state": existing.state
            }
        })
    
    # –ò—â–µ–º –ø–æ order_id (–æ–Ω —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏–∑ /generate-qr)
    payment = Payment.query.filter_by(order_id=order_id).first()
    
    if not payment:
        return jsonify({
            "id": id,
            "error": {"code": -31050, "message": "Order not found"}
        })
    
    # –û–ë–ù–û–í–õ–Ø–ï–ú —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –∑–∞–ø–∏—Å—å (–ù–ï —Å–æ–∑–¥–∞—ë–º –Ω–æ–≤—É—é!)
    payment.transaction_id = transaction_id
    payment.state = 1
    if not payment.create_time:
        payment.create_time = datetime.utcnow()
    
    db.session.commit()
    print(f"DEBUG: ‚úÖ Updated payment with transaction_id: {transaction_id}", flush=True)
    
    return jsonify({
        "id": id,
        "result": {
            "create_time": int(payment.create_time.timestamp() * 1000),
            "transaction": str(payment.id),
            "state": 1
        }
    })
```

---

## ‚úÖ –ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

–ü—Ä–æ–≤–µ—Ä—å –ª–æ–≥–∏ —Å–µ—Ä–≤–µ—Ä–∞. –î–æ–ª–∂–Ω–æ –±—ã—Ç—å:

```
DEBUG: CreateTransaction order_id=photobooth-..., transaction_id=...
DEBUG: ‚úÖ Updated payment with transaction_id: ...
```

**–ù–ï –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å:**
```
‚ùå sqlite3.IntegrityError: UNIQUE constraint failed: payments.order_id
```

---

## üîç –ö–∞–∫ –Ω–∞–π—Ç–∏ –≥–¥–µ –∑–∞–ø—É—â–µ–Ω —Å–µ—Ä–≤–µ—Ä

```bash
# –ù–∞ Windows:
netstat -ano | findstr ":5000"

# –ï—Å–ª–∏ –ø—Ä–æ—Ü–µ—Å—Å –Ω–∞–π–¥–µ–Ω, –Ω–∞–π–¥–∏ –µ–≥–æ:
tasklist | findstr "<PID>"

# –ò–ª–∏ –ø—Ä–æ–≤–µ—Ä—å WSL:
wsl ps aux | grep app.py

# –ò–ª–∏ –ø—Ä–æ–≤–µ—Ä—å —É–¥–∞–ª—ë–Ω–Ω—ã–π —Å–µ—Ä–≤–µ—Ä:
ssh user@10.10.0.172 "ps aux | grep app.py"
```

---

## üìû –ù—É–∂–Ω–∞ –ø–æ–º–æ—â—å?

–ü—Ä–∏—à–ª–∏ –º–Ω–µ:
1. –ì–¥–µ –∑–∞–ø—É—â–µ–Ω —Å–µ—Ä–≤–µ—Ä (–ª–æ–∫–∞–ª—å–Ω–æ/WSL/—É–¥–∞–ª—ë–Ω–Ω–æ)
2. –ö–∞–∫ —Ç—ã –æ–±—ã—á–Ω–æ –∑–∞–ø—É—Å–∫–∞–µ—à—å —Å–µ—Ä–≤–µ—Ä
3. –ï—Å—Ç—å –ª–∏ —É —Ç–µ–±—è SSH –¥–æ—Å—Ç—É–ø –∫ 10.10.0.172

–ò —è –ø–æ–º–æ–≥—É —Å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º–∏ –∫–æ–º–∞–Ω–¥–∞–º–∏.
