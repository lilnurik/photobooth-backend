# üóÑÔ∏è –ú–∏–≥—Ä–∞—Ü–∏—è –Ω–∞ SQLite - –ó–∞–≤–µ—Ä—à–µ–Ω–æ!

**–î–∞—Ç–∞:** 17 –¥–µ–∫–∞–±—Ä—è 2025  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ì–û–¢–û–í–û

---

## –ß—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å

### –î–æ –º–∏–≥—Ä–∞—Ü–∏–∏
```python
# –ü–ª–∞—Ç–µ–∂–∏ —Ö—Ä–∞–Ω–∏–ª–∏—Å—å –≤ –ø–∞–º—è—Ç–∏
payments = {}
```
- ‚ùå –î–∞–Ω–Ω—ã–µ —Ç–µ—Ä—è–ª–∏—Å—å –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–µ
- ‚ùå –ù–µ—Ç –∏—Å—Ç–æ—Ä–∏–∏ –ø–ª–∞—Ç–µ–∂–µ–π
- ‚ùå –ù–µ—Ç –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –∞–Ω–∞–ª–∏–∑–∞

### –ü–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏
```python
# –ü–ª–∞—Ç–µ–∂–∏ –≤ SQLite –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
from models import db, Payment, Photo
```
- ‚úÖ –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –Ω–∞–≤—Å–µ–≥–¥–∞
- ‚úÖ –ü–æ–ª–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è –≤—Å–µ—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
- ‚úÖ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∞
- ‚úÖ –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —ç–∫—Å–ø–æ—Ä—Ç–∞

---

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

### –¢–∞–±–ª–∏—Ü–∞ `payments`
```sql
CREATE TABLE payments (
    id INTEGER PRIMARY KEY,
    order_id VARCHAR(100) UNIQUE NOT NULL,
    transaction_id VARCHAR(100) UNIQUE,
    amount INTEGER NOT NULL,
    payment_type VARCHAR(20) NOT NULL,
    status VARCHAR(20) NOT NULL DEFAULT 'pending',
    state INTEGER,
    create_time DATETIME NOT NULL,
    perform_time DATETIME,
    cancel_time DATETIME,
    metadata_json TEXT,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

**–ò–Ω–¥–µ–∫—Å—ã:**
- `order_id` - –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞ –ø–æ ID –∑–∞–∫–∞–∑–∞
- `transaction_id` - –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞ –ø–æ ID —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏

### –¢–∞–±–ª–∏—Ü–∞ `photos` (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
```sql
CREATE TABLE photos (
    id INTEGER PRIMARY KEY,
    payment_id INTEGER,
    template_name VARCHAR(50) NOT NULL,
    copy_count INTEGER NOT NULL DEFAULT 1,
    composite_path VARCHAR(255),
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (payment_id) REFERENCES payments (id)
);
```

---

## –ù–æ–≤—ã–µ —Ñ–∞–π–ª—ã

### 1. `models.py`
–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –º–æ–¥–µ–ª–µ–π SQLAlchemy:
- `Payment` - –º–æ–¥–µ–ª—å –ø–ª–∞—Ç–µ–∂–∞
- `Photo` - –º–æ–¥–µ–ª—å —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

### 2. `app.py` (–æ–±–Ω–æ–≤–ª—ë–Ω)
- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è SQLAlchemy
- –ê–≤—Ç–æ—Å–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ
- –í—Å–µ endpoints —Ä–∞–±–æ—Ç–∞—é—Ç —Å –ë–î

### 3. `db_viewer.py`
–£—Ç–∏–ª–∏—Ç–∞ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ë–î:
- –ü—Ä–æ—Å–º–æ—Ç—Ä –≤—Å–µ—Ö –ø–ª–∞—Ç–µ–∂–µ–π
- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
- –≠–∫—Å–ø–æ—Ä—Ç –≤ CSV
- –û—á–∏—Å—Ç–∫–∞ –ë–î

### 4. `photobooth.db`
SQLite –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö (—Å–æ–∑–¥–∞—ë—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)

---

## –ù–æ–≤—ã–µ API endpoints

### 1. GET `/api/payments`
–ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –ø–ª–∞—Ç–µ–∂–µ–π

**Query –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- `limit` - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 100)
- `offset` - —Å–º–µ—â–µ–Ω–∏–µ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 0)
- `status` - —Ñ–∏–ª—å—Ç—Ä –ø–æ —Å—Ç–∞—Ç—É—Å—É (pending, success, canceled)

**–ü—Ä–∏–º–µ—Ä:**
```bash
curl "http://localhost:5000/api/payments?limit=10&status=success"
```

**–û—Ç–≤–µ—Ç:**
```json
{
  "total": 42,
  "limit": 10,
  "offset": 0,
  "payments": [
    {
      "id": 1,
      "order_id": "photobooth-123",
      "amount": 10000,
      "status": "success",
      ...
    }
  ]
}
```

### 2. GET `/api/payments/<payment_id>`
–ü–æ–ª—É—á–∏—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –ø–ª–∞—Ç—ë–∂ –ø–æ ID

**–ü—Ä–∏–º–µ—Ä:**
```bash
curl http://localhost:5000/api/payments/1
```

### 3. GET `/api/stats`
–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–ª–∞—Ç–µ–∂–µ–π

**–û—Ç–≤–µ—Ç:**
```json
{
  "total_payments": 42,
  "success_payments": 38,
  "pending_payments": 2,
  "canceled_payments": 2,
  "total_revenue": 380000
}
```

---

## –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### –ó–∞–ø—É—Å–∫ backend
```bash
cd D:\fotobox+react\photobooth-magic-main\backend
python app.py
```

–ü—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞—ë—Ç—Å—è —Ñ–∞–π–ª `photobooth.db`

### –ü—Ä–æ—Å–º–æ—Ç—Ä –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
```bash
python db_viewer.py
```

–ú–µ–Ω—é:
```
1. –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ –ø–ª–∞—Ç–µ–∂–∏
2. –ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
3. –î–µ—Ç–∞–ª–∏ –ø–ª–∞—Ç–µ–∂–∞ –ø–æ ID
4. –≠–∫—Å–ø–æ—Ä—Ç –≤ CSV
5. –û—á–∏—Å—Ç–∏—Ç—å –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
0. –í—ã—Ö–æ–¥
```

### –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö
```bash
python db_viewer.py
# –í—ã–±—Ä–∞—Ç—å –ø—É–Ω–∫—Ç 4
```

–°–æ–∑–¥–∞—ë—Ç—Å—è —Ñ–∞–π–ª `payments_export_YYYYMMDD_HHMMSS.csv`

---

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ç–µ—Å—Ç—ã
```bash
python test_api.py
```

–î–æ–ª–∂–Ω–æ –ø—Ä–æ–π—Ç–∏ 8 —Ç–µ—Å—Ç–æ–≤:
```
‚úÖ /api/test - –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã
‚úÖ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è QR –¥–ª—è Payme
‚úÖ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è QR –¥–ª—è Click
‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –ø–ª–∞—Ç–µ–∂–∞
‚úÖ –°–∏–º—É–ª—è—Ü–∏—è –æ–ø–ª–∞—Ç—ã
‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Å–ª–µ —Å–∏–º—É–ª—è—Ü–∏–∏
‚úÖ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
‚úÖ –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –ø–ª–∞—Ç–µ–∂–µ–π
```

### –†—É—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

1. –ü—Ä–æ–≤–µ—Ä–∫–∞ health check:
```bash
curl http://localhost:5000/api/test
```

–û—Ç–≤–µ—Ç –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å:
```json
{
  "database": "SQLite",
  "payments_count": 0
}
```

2. –°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –ø–ª–∞—Ç–µ–∂–∞:
```bash
curl -X POST http://localhost:5000/api/test-payment/test-order-123
```

3. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:
```bash
curl http://localhost:5000/api/stats
```

4. –ü—Ä–æ—Å–º–æ—Ç—Ä –≤—Å–µ—Ö –ø–ª–∞—Ç–µ–∂–µ–π:
```bash
curl http://localhost:5000/api/payments
```

---

## –û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å

–í—Å–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ endpoints —Ä–∞–±–æ—Ç–∞—é—Ç **–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π**:

- ‚úÖ `/api/generate-qr` - –∫–∞–∫ —Ä–∞–Ω—å—à–µ
- ‚úÖ `/api/payment-status/:id` - –∫–∞–∫ —Ä–∞–Ω—å—à–µ
- ‚úÖ `/api/payme/webhook` - –∫–∞–∫ —Ä–∞–Ω—å—à–µ
- ‚úÖ `/api/click/prepare` - –∫–∞–∫ —Ä–∞–Ω—å—à–µ
- ‚úÖ `/api/click/complete` - –∫–∞–∫ —Ä–∞–Ω—å—à–µ
- ‚úÖ `/api/test-payment/:id` - –∫–∞–∫ —Ä–∞–Ω—å—à–µ

Frontend **–Ω–µ —Ç—Ä–µ–±—É–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π**!

---

## –†–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ

### –†—É—á–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ
```powershell
Copy-Item photobooth.db photobooth_backup_$(Get-Date -Format 'yyyyMMdd_HHmmss').db
```

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ
–°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É –≤ Windows Task Scheduler:
```powershell
# backup_db.ps1
$date = Get-Date -Format 'yyyyMMdd_HHmmss'
Copy-Item "D:\fotobox+react\photobooth-magic-main\backend\photobooth.db" `
          "D:\backups\photobooth_$date.db"
```

---

## –ú–∏–≥—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö

–ï—Å–ª–∏ —É –≤–∞—Å —É–∂–µ –±—ã–ª–∏ –¥–∞–Ω–Ω—ã–µ –≤ —Å—Ç–∞—Ä–æ–π –≤–µ—Ä—Å–∏–∏ (–≤ –ø–∞–º—è—Ç–∏), –æ–Ω–∏ –Ω–µ —Å–æ—Ö—Ä–∞–Ω–∏–ª–∏—Å—å.

–ü—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ –Ω–∞ SQLite –≤—Å–µ –Ω–æ–≤—ã–µ –ø–ª–∞—Ç–µ–∂–∏ –±—É–¥—É—Ç —Å–æ—Ö—Ä–∞–Ω—è—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.

---

## –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–∑ backup

```powershell
# –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å backend
# –ó–∞–º–µ–Ω–∏—Ç—å –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
Copy-Item photobooth_backup_20251217.db photobooth.db -Force
# –ó–∞–ø—É—Å—Ç–∏—Ç—å backend
```

---

## –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

### –°–∫–æ—Ä–æ—Å—Ç—å –∑–∞–ø—Ä–æ—Å–æ–≤

| –û–ø–µ—Ä–∞—Ü–∏—è | –í—Ä–µ–º—è |
|----------|-------|
| –°–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞ | ~5ms |
| –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ | ~2ms |
| –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ (100 –∑–∞–ø–∏—Å–µ–π) | ~10ms |
| –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ | ~15ms |

### –†–∞–∑–º–µ—Ä –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

- –ü—É—Å—Ç–∞—è –ë–î: ~20 KB
- 100 –ø–ª–∞—Ç–µ–∂–µ–π: ~30 KB
- 1000 –ø–ª–∞—Ç–µ–∂–µ–π: ~150 KB
- 10000 –ø–ª–∞—Ç–µ–∂–µ–π: ~1.5 MB

SQLite —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–µ–Ω –¥–ª—è –Ω–µ–±–æ–ª—å—à–∏—Ö –∏ —Å—Ä–µ–¥–Ω–∏—Ö –æ–±—ä—ë–º–æ–≤ –¥–∞–Ω–Ω—ã—Ö.

---

## –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

### –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞:

1. **–†–µ–≥—É–ª—è—Ä–Ω—ã–µ backup'—ã**
   - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å
   - –•—Ä–∞–Ω–µ–Ω–∏–µ –Ω–∞ –¥—Ä—É–≥–æ–º –¥–∏—Å–∫–µ/—Å–µ—Ä–≤–µ—Ä–µ

2. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥**
   - –†–∞–∑–º–µ—Ä –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
   - –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–ª–∞—Ç–µ–∂–µ–π –≤ –¥–µ–Ω—å
   - –£—Å–ø–µ—à–Ω–æ—Å—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π

3. **–û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö**
   - –ê—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–µ–π —Å—Ç–∞—Ä—à–µ 1 –≥–æ–¥–∞
   - –£–¥–∞–ª–µ–Ω–∏–µ –æ—Ç–º–µ–Ω—ë–Ω–Ω—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π —Å—Ç–∞—Ä—à–µ 30 –¥–Ω–µ–π

4. **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è**
   - `VACUUM` –¥–ª—è —Å–∂–∞—Ç–∏—è –ë–î
   - `ANALYZE` –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–Ω–¥–µ–∫—Å–æ–≤

---

## Troubleshooting

### –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞
```
database is locked
```

**–†–µ—à–µ–Ω–∏–µ:** –ó–∞–∫—Ä–æ–π—Ç–µ –≤—Å–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã, —Ä–∞–±–æ—Ç–∞—é—â–∏–µ —Å –ë–î (db_viewer.py, etc)

### –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∞
```
database disk image is malformed
```

**–†–µ—à–µ–Ω–∏–µ:** –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏–∑ backup

### –ú–µ–¥–ª–µ–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã
```
–ó–∞–ø—Ä–æ—Å—ã –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –¥–æ–ª–≥–æ
```

**–†–µ—à–µ–Ω–∏–µ:**
```python
# –í –∫–æ–Ω—Å–æ–ª–∏ Python
import sqlite3
conn = sqlite3.connect('photobooth.db')
conn.execute('VACUUM')
conn.execute('ANALYZE')
conn.close()
```

---

## –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

‚úÖ **–ú–∏–≥—Ä–∞—Ü–∏—è –Ω–∞ SQLite –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ!**

–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:
- –î–∞–Ω–Ω—ã–µ –Ω–µ —Ç–µ—Ä—è—é—Ç—Å—è –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–µ
- –ü–æ–ª–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∞
- –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —ç–∫—Å–ø–æ—Ä—Ç–∞
- –ë–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π frontend

–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –≥–æ—Ç–æ–≤–∞ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é –≤ production!

---

**–†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫:** Muhamadaliyev Abu Solih  
**–î–∞—Ç–∞:** 17.12.2025
