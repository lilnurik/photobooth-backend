# ‚ö° –°–†–û–ß–ù–û! –ö–æ–º–∞–Ω–¥—ã –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ù–ê –°–ï–†–í–ï–†–ï

## üö® –ü–†–û–ë–õ–ï–ú–ê
–ù–∞ —Å–µ—Ä–≤–µ—Ä–µ `/var/www/photobooth-backend/app.py` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –°–¢–ê–†–´–ô –ö–û–î!
–ú–æ–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏–∑ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Ñ–∞–π–ª–∞ –ù–ï –ø—Ä–∏–º–µ–Ω–∏–ª–∏—Å—å.

---

## ‚úÖ –†–ï–®–ï–ù–ò–ï (–≤—ã–ø–æ–ª–Ω–∏ —ç—Ç–∏ –∫–æ–º–∞–Ω–¥—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ)

### –í–∞—Ä–∏–∞–Ω—Ç 1: –ß–µ—Ä–µ–∑ nano (–†–ï–ö–û–ú–ï–ù–î–£–Æ)

```bash
# 1. SSH –Ω–∞ —Å–µ—Ä–≤–µ—Ä
ssh root@10.10.0.172

# 2. –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–µ—Ä–≤–µ—Ä
cd /var/www/photobooth-backend
pkill -f "python.*app.py"

# 3. –û—Ç–∫—Ä—ã—Ç—å —Ñ–∞–π–ª
nano app.py

# 4. –ù–∞–π—Ç–∏ —Å—Ç—Ä–æ–∫—É (Ctrl+W):
elif method == 'CreateTransaction':

# 5. –£–î–ê–õ–ò–¢–¨ –≤–µ—Å—å –±–ª–æ–∫ –¥–æ —Å–ª–µ–¥—É—é—â–µ–≥–æ elif (–ø—Ä–∏–º–µ—Ä–Ω–æ 30 —Å—Ç—Ä–æ–∫)

# 6. –í–°–¢–ê–í–ò–¢–¨ –Ω–æ–≤—ã–π –∫–æ–¥ (Ctrl+Shift+V):
# (–∫–æ–¥ –Ω–∏–∂–µ)

# 7. –°–æ—Ö—Ä–∞–Ω–∏—Ç—å (Ctrl+O, Enter, Ctrl+X)

# 8. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å
nohup python app.py > photobooth.log 2>&1 &

# 9. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å
tail -f photobooth.log | grep CreateTransaction
```

---

## üìù –ù–û–í–´–ô –ö–û–î –¥–ª—è –≤—Å—Ç–∞–≤–∫–∏ (—Å–∫–æ–ø–∏—Ä—É–π —ç—Ç–æ):

```python
    elif method == 'CreateTransaction':
        transaction_id = params.get('id')
        amount = params.get('amount')
        account = params.get('account', {})
        order_id = account.get('order_id')
        
        print(f"DEBUG: CreateTransaction order_id={order_id}, transaction_id={transaction_id}", flush=True)
        
        try:
            # ‚úÖ –ü–†–û–í–ï–†–ö–ê 1: –ú–æ–∂–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è —É–∂–µ –±—ã–ª–∞ —Å–æ–∑–¥–∞–Ω–∞ —Ä–∞–Ω–µ–µ (–ø–æ–≤—Ç–æ—Ä–Ω—ã–π –∑–∞–ø—Ä–æ—Å)
            existing_transaction = Payment.query.filter_by(transaction_id=transaction_id).first()
            if existing_transaction:
                print(f"DEBUG: Transaction already exists: {transaction_id}, returning existing", flush=True)
                return jsonify({
                    "id": id,
                    "result": {
                        "create_time": int(existing_transaction.create_time.timestamp() * 1000),
                        "transaction": str(existing_transaction.id),
                        "state": existing_transaction.state
                    }
                })
            
            # ‚úÖ –ü–†–û–í–ï–†–ö–ê 2: –ò—â–µ–º –ø–ª–∞—Ç—ë–∂ –ø–æ order_id (–æ–Ω –±—ã–ª —Å–æ–∑–¥–∞–Ω –≤ /generate-qr)
            payment = Payment.query.filter_by(order_id=order_id).first()
            
            if not payment:
                print(f"ERROR: Order not found: {order_id}", flush=True)
                return jsonify({
                    "id": id,
                    "error": {"code": -31050, "message": f"Order not found: {order_id}"}
                })
            
            # ‚úÖ –û–ë–ù–û–í–õ–ï–ù–ò–ï: –ü—Ä–∏–≤—è–∑—ã–≤–∞–µ–º transaction_id –∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–º—É –ø–ª–∞—Ç–µ–∂—É
            print(f"DEBUG: Updating payment: order_id={order_id} with transaction_id={transaction_id}", flush=True)
            
            payment.transaction_id = transaction_id
            payment.state = 1  # created
            if not payment.create_time:
                payment.create_time = datetime.utcnow()
            
            db.session.commit()
            
            print(f"DEBUG: ‚úÖ Payment updated successfully: order_id={order_id}, transaction_id={transaction_id}", flush=True)
            
            return jsonify({
                "id": id,
                "result": {
                    "create_time": int(payment.create_time.timestamp() * 1000),
                    "transaction": str(payment.id),
                    "state": 1
                }
            })
            
        except Exception as e:
            print(f"ERROR in CreateTransaction: {e}", flush=True)
            db.session.rollback()
            return jsonify({
                "id": id,
                "error": {"code": -32400, "message": f"Internal error: {str(e)}"}
            })
```

---

## –í–∞—Ä–∏–∞–Ω—Ç 2: –ß–µ—Ä–µ–∑ sed (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)

‚ö†Ô∏è –û–°–¢–û–†–û–ñ–ù–û! –°–¥–µ–ª–∞–π –±—ç–∫–∞–ø –ø–µ—Ä–µ–¥ —ç—Ç–∏–º:

```bash
# –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ
cd /var/www/photobooth-backend

# 1. –ë—ç–∫–∞–ø
cp app.py app.py.backup.$(date +%s)

# 2. –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π —Ñ–∞–π–ª —Å –ª–æ–∫–∞–ª—å–Ω–æ–π –º–∞—à–∏–Ω—ã
# (—Å Windows –Ω–∞ Linux)
```

–ü–æ—Ç–æ–º —Å –ª–æ–∫–∞–ª—å–Ω–æ–π –º–∞—à–∏–Ω—ã:
```bash
scp D:\fotobox+react\photobooth-magic-main\backend\app.py root@10.10.0.172:/var/www/photobooth-backend/app.py
```

---

## –í–∞—Ä–∏–∞–Ω—Ç 3: –ß–µ—Ä–µ–∑ Git (–µ—Å–ª–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω)

```bash
# –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ
cd /var/www/photobooth-backend
git stash  # —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –ª–æ–∫–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
git pull origin main
pkill -f "python.*app.py"
nohup python app.py > photobooth.log 2>&1 &
```

---

## ‚úÖ –ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ–≤–µ—Ä—å –ª–æ–≥:

```bash
tail -f photobooth.log
```

**–î–æ–ª–∂–Ω–æ –±—ã—Ç—å:**
```
DEBUG: CreateTransaction order_id=..., transaction_id=...
DEBUG: Updating payment: order_id=... with transaction_id=...
DEBUG: ‚úÖ Payment updated successfully
```

**–ù–ï –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å:**
```
‚ùå sqlite3.IntegrityError: UNIQUE constraint failed
```

---

## üîç –ö–∞–∫ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–∞–∫–∞—è –≤–µ—Ä—Å–∏—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ:

```bash
# –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ
cd /var/www/photobooth-backend
grep "–ü–†–û–í–ï–†–ö–ê 1" app.py
```

**–ï—Å–ª–∏ –Ω–∞—à–ª–∞—Å—å —ç—Ç–∞ —Å—Ç—Ä–æ–∫–∞** ‚Üí –∫–æ–¥ –æ–±–Ω–æ–≤–ª—ë–Ω ‚úÖ  
**–ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∞—Å—å** ‚Üí –∫–æ–¥ —Å—Ç–∞—Ä—ã–π ‚ùå

---

## ‚ö° –ë–´–°–¢–†–ê–Ø –ö–û–ú–ê–ù–î–ê (–≤—Å—ë –≤ –æ–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–µ):

```bash
ssh root@10.10.0.172 "cd /var/www/photobooth-backend && pkill -f python.*app.py && git pull && nohup python app.py > photobooth.log 2>&1 &"
```

–ù–æ –°–ù–ê–ß–ê–õ–ê –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å `git push` –Ω–∞ –ª–æ–∫–∞–ª—å–Ω–æ–π –º–∞—à–∏–Ω–µ!

---

## üéØ –ò—Ç–æ–≥–æ:

1. **–õ–æ–∫–∞–ª—å–Ω–æ:** `git add . && git commit -m "Fix Payme" && git push`
2. **–ù–∞ —Å–µ—Ä–≤–µ—Ä–µ:** `git pull && restart`
3. **–ü—Ä–æ–≤–µ—Ä–∫–∞:** –ª–æ–≥–∏ –¥–æ–ª–∂–Ω—ã –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å "‚úÖ Payment updated successfully"

**–í—Ä–µ–º—è:** 2 –º–∏–Ω—É—Ç—ã üöÄ
